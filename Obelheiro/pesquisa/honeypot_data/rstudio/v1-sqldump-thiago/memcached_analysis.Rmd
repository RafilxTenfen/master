---
title: "memcached analysis"
author: "Rafilx"
date: '2022-06-19'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library("dplyr")
require(gridExtra)
library(tibble)
library(viridis)
library(lubridate)
library(blob)

library(stringi)
library(stringr)
library(eply)
#install.packages('eply')
#library("dplyr.teradata")
# library("dplyr.teradata")
```

## R Markdown

Na dissertação, foi relatado que

- 3,1% das requisições de Memcached eram variações de `stats`
- 91,6% das requisições eram `set` ou `get`
- 5,1% das requisições eram malformadas (e.g., requisições HTTP ou SSDP) ou eram `flush_all` (para limpar chaves do cache)

É possível fazer essa análise por trimestre, ou ao menos analisar a incidência de `stats` e `set`+`get`

```{r fetch_data}
db <- dbConnect(RSQLite::SQLite(), dbname="../db/database-2022-05-11/mix_protocol.sqlite")


data_unfetch <-dbSendQuery(db, "
  SELECT ip, requests_per_attack, tempo_inicio, tempo_final, QUOTE(payload) as quote_payload, QUOTE(get_payload_value) as quote_payload_get,
         payload_decoded, payload, raw_payload,
         CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, SUBSTR(payload,0,25) AS payload_limit, memcached_request_type
    FROM (
      SELECT *,  strftime(\"%Y\", tempo_inicio) as year, ((strftime(\"%m\", tempo_final) - 1) / 3) + 1 AS period
        FROM MEMCACHED_ANALYSIS
    )
")

data <- fetch(data_unfetch)

data_memcached_payload_types_unfetch <-dbSendQuery(db, "
  SELECT id, quantity, SUBSTR(payload,0,25) AS payload_limit
    FROM MEMCACHED_PAYLOAD_TYPES
")
data_memcached_payload_types <- fetch(data_memcached_payload_types_unfetch)


dbDisconnect(db)
```


```{r}
data['tempo_final_cast'] = as.POSIXct(data[['tempo_final']], format = "%Y-%m-%d %H:%M:%S")
data['tempo_inicio_cast'] = as.POSIXct(data[['tempo_inicio']], format = "%Y-%m-%d %H:%M:%S")
```


```{r}
memcached_payload_types = data_memcached_payload_types %>%
  mutate(payload_str = toString(payload_limit)) %>%
  arrange(desc(quantity)) %>%
  select('quantity', 'payload_limit', 'id') 

memcached_payload_types_quantity_percentage = memcached_payload_types %>%
  mutate(sum_quantity = sum(quantity)) %>%
  mutate(quantity_percentage = (quantity / sum_quantity) * 100)

memcached_payload_types_quantity_percentage %>%
  select('quantity', 'quantity_percentage', 'payload_limit') %>%
  arrange(desc(quantity)) %>%
  head(15)

```

```{r fig.width = 14}
  
 memcached_payload_types_quantity_percentage %>%
  arrange(desc(quantity)) %>%
  filter(quantity > 0) %>%
  select('quantity_percentage', 'payload_limit') %>%
  ggplot( aes(x=payload_limit, y=quantity_percentage)) + 
    geom_bar(stat="identity", width = 0.7, position="dodge") +
    geom_text(aes(label = paste(round(quantity_percentage, 3), "%"),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE, direction = -1) +
    # theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +
    ylab("Porcentagem") +
    xlab("Comando") +
    ggtitle("Porcentagem da quantidade de comandos memcached")
```




- Agrupamento realizado por período (trimestre) e "memcached_request_type" é o comando utilizado no ataque `["stats", "set", "get", "add", "cas", "replace", "append", "prepend", "flush_all", "outros"]`
- Somando a quantidade de requisições utilizadas por cada comando e período


```{r}


data_grouped_period_command = data %>%
  mutate(year_period_int = year_period,
         year_period = as.factor(year_period),
         command = as.factor(memcached_request_type)) %>%
  group_by(year_period, command) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_attacks = n(),
            tempo_inicio=min(tempo_inicio_cast),
            tempo_final=max(tempo_final_cast))

data_grouped_period_command_percentage = data_grouped_period_command %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(command = command,
            number_of_attacks = number_of_attacks,
            tempo_inicio = tempo_inicio,
            tempo_final = tempo_final,
            sum_period_number_of_attacks = sum(number_of_attacks),
            sum_period_requests_per_attack = sum(sum_requests_per_attack),
            sum_requests_per_attack = sum_requests_per_attack) %>%
  mutate(number_of_attacks_percentage = (number_of_attacks / sum_period_number_of_attacks) * 100,
         number_of_requests_percentage = (sum_requests_per_attack / sum_period_requests_per_attack) * 100)


minimum_percentage_as_others = 1
decimals_digits = 1

data_grouped_period_command_others_percentage = data_grouped_period_command_percentage %>%
  mutate(
    command = case_when(
      number_of_requests_percentage < minimum_percentage_as_others ~ "OUTROS",
      TRUE ~ as.character(command)
    )
  ) %>%
  group_by(year_period, command) %>%
  summarise(number_of_requests_percentage = sum(number_of_requests_percentage))
```

```{r}
data_grouped_period_command_others_percentage %>%
  print(n=16)
```

> Porcentagem menores que `r minimum_percentage_as_others` foram agrupadas como "OUTROS"

- Gráfico de barras 2020 ~ 2022
```{r fig.width = 16}
data_grouped_period_command_others_percentage %>%
  ggplot( aes(x=command, y=number_of_requests_percentage, fill=command)) +
    geom_bar(stat="identity", width = 0.5, position="dodge") +
    geom_text(aes(label = paste(round(number_of_requests_percentage, decimals_digits), "%"),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +
    facet_grid(~year_period) +
    ylab("Porcentagem da quantidade de comandos") +
    xlab("Período (Trimestre)") +
    ggtitle("Comandos memcached 2020 ~ 2022")
```


- Gráfico de barras empilhadas 2020 ~ 2022
```{r fig.width = 16}
data_grouped_period_command_others_percentage %>%
  ggplot( aes(x=year_period, y=number_of_requests_percentage, fill=command)) +
    geom_bar(stat="identity", width = 0.5) +
    geom_text(aes(label = paste(round(number_of_requests_percentage, decimals_digits), "%")), position = position_stack(vjust = 0.1)) +
    scale_fill_viridis(discrete=TRUE) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    ylab("Porcentagem da quantidade de comandos") +
    xlab("Período (Trimestre)") +
    ggtitle("Comandos memcached 2020 ~ 2022")
```

- Gráfico de linhas 2020 ~ 2022
```{r fig.width = 16}
data_grouped_period_command_others_percentage %>%
  ggplot( aes(x=year_period, y=number_of_requests_percentage, group=command)) +
    geom_line(size=1.2, aes(color=command)) +
    geom_point(color="red", size=3,  aes(color=command)) +
    geom_text(
      aes(label = paste(round(number_of_requests_percentage, decimals_digits), "%")),
      hjust = -0.03, nudge_x = 0.05, nudge_y = -1, angle = -10,
    ) +
    scale_fill_viridis(discrete=TRUE) +
    theme(
      axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
    ) +
    ylab("Porcentagem da quantidade de comandos") +
    xlab("Período (Trimestre)") +
    ggtitle("Comandos memcached 2020 ~ 2022")
```

```{r}


data_grouped_period_payload = data %>%
  mutate(year_period = as.factor(year_period),
         payload = as.factor(raw_payload)) %>%
  group_by(year_period, payload) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_payloads_by_period = n())

data_grouped_period_payload_percentage = data_grouped_period_payload %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(payload = payload,
            number_of_payloads_by_period = number_of_payloads_by_period,
            sum_number_of_payloads_by_period = sum(number_of_payloads_by_period),
            sum_period_requests_per_attack = sum(sum_requests_per_attack),
            sum_requests_per_attack = sum_requests_per_attack) %>%
  mutate(number_of_payloads_percentage = (number_of_payloads_by_period / sum_number_of_payloads_by_period) * 100,
         number_of_requests_percentage = (sum_requests_per_attack / sum_period_requests_per_attack) * 100)

data_grouped_period_payload_others_percentage = data_grouped_period_payload_percentage %>%
  mutate(
    payload = case_when(
      number_of_payloads_percentage < minimum_percentage_as_others ~ "OUTROS",
      TRUE ~ as.character(payload)
    )
  ) %>%
  group_by(year_period, payload) %>%
  summarise(
    number_of_payloads_percentage = sum(number_of_payloads_percentage))
```

> Porcentagem menores que `r minimum_percentage_as_others` foram agrupadas como "OUTROS"
> payload foi limitado a mostrar os 45 primeiros characteres

- Esses dados podem ser analisados como
  - year_period = ano e trimestre
  - payload = o payload utilizado no ataque, aqueles payloads pouco utilizados > `r minimum_percentage_as_others` foi agrupado
  como "OUTROS"
  - number_of_payloads_percentage = porcentagem da quantidade de ataques que utilizaram o mesmo payload naquele período
  nesse caso cada trimestre (year_period) tem um somatório de 100% do campo (number_of_payloads_percentage)
- Gráfico de barras 2020 ~ 2022
```{r fig.width = 16}
data_grouped_period_payload_others_percentage %>%
  mutate(payload_limit=substr(payload, 0, 45)) %>%
  ggplot( aes(x=payload_limit, y=number_of_payloads_percentage, fill=payload_limit)) +
    geom_bar(stat="identity", width = 0.5, position="dodge") +
    geom_text(aes(label = paste(round(number_of_payloads_percentage, decimals_digits), "%"),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +
    facet_grid(~year_period) +
    ylab("Porcentagem de ataques agrupados por payload e periodo") +
    xlab("Payloads") +
    ggtitle("Payloads memcached 2020 ~ 2022")
```

```{r}
data_grouped_period_payload_others_percentage %>%
  mutate(
    payload_limit=case_when(
      payload == "OUTROS" ~ as.character(payload),
      TRUE ~ substr(payload, 35, 80)
    )
    ) %>%
  select('year_period', 'percentage'='number_of_payloads_percentage', 'payload_limit') %>%
  print(n=35)
```

# Dados do payload get
- São o resto do payload após o "get"
```{r}
data_get_payload = data %>%
  filter(memcached_request_type %in% c("Get")) %>%
  select(year_period, requests_per_attack, quote_payload_get, raw_payload)

data_grouped_period_payload_get = data_get_payload %>%
  mutate(year_period = as.factor(year_period),
         payload_get = as.factor(quote_payload_get)) %>%
  group_by(year_period, payload_get) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_payloads_get_by_period = n())



data_grouped_period_payload_get_percentage = data_grouped_period_payload_get %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(payload_get = payload_get,
            number_of_payloads_get_by_period = number_of_payloads_get_by_period,
            sum_number_of_payloads_get_by_period = sum(number_of_payloads_get_by_period),
            sum_period_requests_per_attack = sum(sum_requests_per_attack),
            sum_requests_per_attack = sum_requests_per_attack) %>%
  mutate(number_of_payloads_get_percentage = (number_of_payloads_get_by_period / sum_number_of_payloads_get_by_period) * 100,
         number_of_requests_percentage = (sum_requests_per_attack / sum_period_requests_per_attack) * 100)

data_grouped_period_payload_get_others_percentage = data_grouped_period_payload_get_percentage %>%
  mutate(
    payload_get = case_when(
      number_of_payloads_get_percentage < minimum_percentage_as_others ~ "OUTROS",
      TRUE ~ as.character(payload_get)
    )
  ) %>%
  group_by(year_period, payload_get) %>%
  summarise(
    number_of_payloads_get_percentage = sum(number_of_payloads_get_percentage)
    )
```
- Esse gráfico não ficou bacana, mas da uma noção
- Nesses dados, foi pego somente os registros que eram do tipo "get" e os payloads após o byte 'get', que tecnicamente representa o que foi a key buscada pelo comando get
- Gráfico de barras 2020 ~ 2022
```{r fig.width = 16}
data_grouped_period_payload_get_others_percentage %>%
  mutate(payload_limit=substr(payload_get, 0, 25)) %>%
  ggplot( aes(x=payload_limit, y=number_of_payloads_get_percentage, fill=payload_limit)) +
    geom_bar(stat="identity", width = 0.5, position="dodge") +
    geom_text(aes(label = paste(round(number_of_payloads_get_percentage, decimals_digits), "%"),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1)) +
    facet_grid(~year_period) +
    ylab("Porcentagem de payloads do tipo get agrupados por payload e periodo") +
    xlab("Payloads") +
    ggtitle("Get Payloads memcached 2020 ~ 2022")
```

```{r}
data_grouped_period_payload_get_others_percentage_with_raw_payload = left_join(x=data_grouped_period_payload_get_others_percentage, y=data, 
          by=c("payload_get" = "quote_payload_get"),
          keep=FALSE,
          copy = FALSE
          ) %>%
  count(year_period.x, payload_get, number_of_payloads_get_percentage, raw_payload) %>%
  select(year_period = year_period.x, payload_get,  percentage=number_of_payloads_get_percentage, raw_payload)


data_grouped_period_payload_get_others_percentage_with_raw_payload %>%
  mutate(
    payload_limit=case_when(
      payload_get == "OUTROS" ~ as.character(payload_get),
      TRUE ~ substr(raw_payload, 35, 80)
    )
    ) %>%
  select(year_period, percentage, payload_limit) %>%
  print(n=24)
```

 