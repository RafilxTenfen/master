---
title: "apresentacao_ssdp_coap_cldap"
author: "Rafilx"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library(dplyr)
require(gridExtra)
library(tibble)
library(tidyr)
library(viridis)
library(lubridate)
library(blob)
library(scales)
library(ggrepel)
```
```{r echo=FALSE}
addUnits <- function(n) {
  labels <- ifelse(n < 1000, n, # less than thousands
    ifelse(n < 1e6, paste0(round(n/1e3, 1), 'k'), # in thousands
      ifelse(n < 1e9, paste0(round(n/1e6, 1), 'M'), # in millions
        ifelse(n < 1e12, paste0(round(n/1e9, 2), 'B'), # in billions
          ifelse(n < 1e15, paste0(round(n/1e12, 3), 'T'), # in trillions
  'too big!')))))
  return(labels)
}

addUnitMeses <- function(n){
  return(paste(n, "meses"))
}

minutes = 60
hours = minutes * 60
days = hours * 24
months = days * 30
years = months * 12

addUnitsHours <- function(n) {
  labels <- ifelse(n < minutes, n, # less than 60
    ifelse(n < hours, paste0(round(n/minutes), 'Min'), # in hours
      ifelse(n < months, paste0(round(n/hours, 1), 'Horas'), # in millions
        ifelse(n < years, paste0(round(n/months, 2), 'Meses'), # in billions
          ifelse(n < 1e15, paste0(round(n/years, 3), 'Anos'), # in trillions
  'too big!')))))
  return(labels)
}


labelBiggerThan9 <- function(n){
  labels <- ifelse(n > 9, paste(round(n, 2), "%"), "")
  return(labels)
}

safe_colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499",
                             "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")
minimum_percentage_as_others = 5
decimals_digits = 2
plots_path = "/home/rafilx/projects/github.com/RafilxTenfen/master/Obelheiro/pesquisa/honeypot_data/rstudio/v1-sqldump-thiago/plots"
```

```{r}
db_ssdp <- dbConnect(RSQLite::SQLite(), dbname="../../db/database-2022-05-11/dnstor_statistics_ssdp.sqlite")

data_ssdp_unfetch <-dbSendQuery(db_ssdp, "
  SELECT ip AS vitima_ip, count AS requests_per_attack, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, *
    FROM (
      SELECT *,  strftime(\"%Y\", tempoFinal) as year, ((strftime(\"%m\", tempoFinal) - 1) / 3) + 1 AS period
        FROM SSDP_MEMORY_DICT
   LEFT JOIN SSDP_PAYLOAD_DICT
          ON SSDP_MEMORY_DICT.payloadID = SSDP_PAYLOAD_DICT.payloadID
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_ssdp <- fetch(data_ssdp_unfetch)

dbDisconnect(db_ssdp)
```

- Quantidade de SSDP com 0 bytes payload
```{r}
data_ssdp %>%
  group_by(year_period, payloadID, payload) %>%
  summarise(attacks = n(), requests = sum(requests_per_attack)) %>%
  
``` 

```{r}
data_ssdp_period = data_ssdp %>%
  group_by(year_period) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_attacks = n(),
            count_victim = n_distinct(vitima_ip))

data_ssdp_period = data_ssdp_period %>%
  mutate(requests_by_attack = sum_requests_per_attack/number_of_attacks) %>%


print(data_ssdp_period, n=16)
```

```{r fig.width = 16, fig.height=10}
plot_ssdp_req_by_attaq = data_ssdp_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=requests_by_attack)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(requests_by_attack),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de requisições por ataques") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("SSDP - Requisições / Ataques por trimestre")

plot_ssdp_req_by_attaq
```

- SSDP Plot Requisições
```{r fig.width = 16, fig.height=12}
data_ssdp_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=sum_requests_per_attack)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(sum_requests_per_attack),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de requisições") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("SSDP - Requisições por trimestre")
```

- SSDP Plot Ataques
```{r fig.width = 16, fig.height=10}
data_ssdp_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=number_of_attacks)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(number_of_attacks),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de ataques") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("SSDP - Ataques por trimestre")
```

- Pergunta, alguma suposição do motivo de tantas requisições/ataques em 2019/2

- SSDP Novas Vítimas
```{r}

data_ssdp_period_new_victim = data_ssdp %>%
  ungroup() %>%
  group_by(vitima_ip) %>%
  summarise(year_period = min(year_period)) %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(new_victims = n_distinct(vitima_ip)) %>%
  mutate(year_period=as.factor(year_period))

```

- SSDP Plot Novas Vítimas
```{r fig.width = 16, fig.height=12}

ssdp_plot_new_victim = data_ssdp_period_new_victim %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=new_victims)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(new_victims),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de novas vítimas") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("SSDP - Novas Vítimas")
#
# pdf(paste(plots_path, "/ssdp.pdf", sep=""), width = 16, height = 10, pointsize=16)
# print(ssdp_plot_new_victim)
# dev.off()

ssdp_plot_new_victim

```

### COAP


```{r}
db_coap <- dbConnect(RSQLite::SQLite(), dbname="../../db/database-2022-05-11/dnstor_statistics_coap.sqlite")

data_coap_unfetch <-dbSendQuery(db_coap, "
  SELECT ip AS vitima_ip, count AS requests_per_attack, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, tempoInicio, tempoFinal, year
    FROM (
      SELECT *,  strftime(\"%Y\", tempoFinal) as year, ((strftime(\"%m\", tempoFinal) - 1) / 3) + 1 AS period
        FROM COAP_MEMORY_DICT
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_coap <- fetch(data_coap_unfetch)



data_coap_payload_unfetch <-dbSendQuery(db_coap, "
  SELECT ip AS vitima_ip, count AS requests_per_attack, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, tempoInicio, tempoFinal, year, payload
    FROM (
      SELECT *,  strftime(\"%Y\", tempoFinal) as year, ((strftime(\"%m\", tempoFinal) - 1) / 3) + 1 AS period
    	  FROM COAP_MEMORY_DICT
    	  JOIN COAP_PAYLOAD_DICT
    		  ON COAP_MEMORY_DICT.payloadID = COAP_PAYLOAD_DICT.payloadID
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_coap_payload <- fetch(data_coap_payload_unfetch)

dbDisconnect(db_coap)
```

- Dados gerais

```{r}
data_coap %>%
  group_by() %>%
    summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_attacks = n(),
            count_victim = n_distinct(vitima_ip))
```


```{r}
data_coap %>%
  arrange(desc(tempoFinal))

data_coap_period = data_coap %>%
  group_by(year_period) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_attacks = n(),
            count_victim = n_distinct(vitima_ip))  %>%
  mutate(requests_by_attack = sum_requests_per_attack/number_of_attacks)

print(data_coap_period, n=16)
```

- COAP Plot Requisições
```{r fig.width = 16, fig.height=12}
data_coap_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=sum_requests_per_attack)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(sum_requests_per_attack),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de requisições") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("COAP - Requisições por trimestre")
```

- COAP Plot Ataques
```{r fig.width = 16, fig.height=12}
data_coap_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=number_of_attacks)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = number_of_attacks,  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de ataques") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("COAP - Ataques por trimestre")
```

- Ataques com muitas requisições em 2020/4
- Muitos ataques com "poucas" requisições em 2021/4, resultando em várias novas vítimas

- COAP Novas Vítimas
```{r}

data_coap_period_new_victim = data_coap %>%
  ungroup() %>%
  group_by(vitima_ip) %>%
  summarise(year_period = min(year_period)) %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(new_victims = n_distinct(vitima_ip)) %>%
  mutate(year_period=as.factor(year_period))

```

- CoAP Plot Novas Vítimas
```{r fig.width = 16, fig.height=12}

data_coap_period_new_victim %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=new_victims)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = new_victims,  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de novas vítimas") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("COAP - Novas Vítimas")
```

- Coap payload

```{r}

data_coap_payload %>%
  count(payload)
```



### CLDAP


```{r}
db_cldap <- dbConnect(RSQLite::SQLite(), dbname="../../db/database-2022-05-11/dnstor_statistics_cldap.sqlite")

data_cldap_unfetch <-dbSendQuery(db_cldap, "
  SELECT ip AS vitima_ip, count AS requests_per_attack, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, tempoInicio, tempoFinal
    FROM (
      SELECT *,  strftime(\"%Y\", tempoFinal) as year, ((strftime(\"%m\", tempoFinal) - 1) / 3) + 1 AS period
        FROM CLDAP_MEMORY_DICT
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_cldap <- fetch(data_cldap_unfetch)



data_cldap_unfetch_payload <-dbSendQuery(db_cldap, "
  SELECT ip AS vitima_ip, count AS requests_per_attack, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period, payload
    FROM (
      SELECT *,  strftime(\"%Y\", tempoFinal) as year, ((strftime(\"%m\", tempoFinal) - 1) / 3) + 1 AS period
        FROM CLDAP_MEMORY_DICT
        JOIN CLDAP_PAYLOAD_DICT
		      ON CLDAP_MEMORY_DICT.payloadID = CLDAP_PAYLOAD_DICT.payloadID
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_cldap_payload <- fetch(data_cldap_unfetch_payload)


dbDisconnect(db_cldap)
```

```{r}
data_cldap['tempo_final_cast'] = as.POSIXct(data_cldap[['tempoFinal']], format = "%Y-%m-%d %H:%M:%S")
data_cldap['tempo_inicio_cast'] = as.POSIXct(data_cldap[['tempoInicio']], format = "%Y-%m-%d %H:%M:%S")

data_cldap %>%
  group_by() %>%
  summarise(
    sum_requests_per_attack = sum(requests_per_attack),
    number_of_attacks = n(),
    count_victim = n_distinct(vitima_ip),
    tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast),
  )

```


- Periodo

```{r}
data_cldap_period = data_cldap %>%
  group_by(year_period) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack),
            number_of_attacks = n(),
            count_victim = n_distinct(vitima_ip)) %>%
  mutate(requests_by_attack = sum_requests_per_attack/number_of_attacks)

print(data_cldap_period, n=16)

data_cldap %>%
  arrange(tempoInicio)
```

- CLDAP Plot Requisições/ataques
```{r fig.width = 16, fig.height=8}
plot_cldap_req_by_attaq = data_cldap_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=requests_by_attack)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(requests_by_attack),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade ") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("CLDAP - Requisições/Ataques por trimestre")

plot_cldap_req_by_attaq
```

- Os ultimos quatro trimestres foram inferiores aos demais

- CLDAP Plot Requisições
```{r fig.width = 16, fig.height=10}
cldap_plot_req = data_cldap_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=sum_requests_per_attack)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(sum_requests_per_attack),  vjust = -0.25), size = 7) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Requisições") +
    xlab("Período (Trimestre)") +
    theme(
      strip.text = element_text(size = 30),
      axis.text.x = element_text(size = 21),
      axis.text.y = element_text(size = 30),
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
    ) +
    ggtitle("CLDAP - Volume de Requisições")

cldap_plot_req
```

- 2 teorias
  - mudaram atacantes/ferramentas de ataques
  - os ataques estão sendo pulverizados em mais refletores
      - Talvez houve
      - filtragem rate-limiting

- CLDAP Plot Ataques
```{r fig.width = 16, fig.height=10}
cldap_plot_ataq = data_cldap_period %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=number_of_attacks)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(number_of_attacks),  vjust = -0.25), size = 7) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Ataques") +
    xlab("Período (Trimestre)") +
    theme(
      strip.text = element_text(size = 30),
      axis.text.x = element_text(size = 21),
      axis.text.y = element_text(size = 30),
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
    ) +
    ggtitle("CLDAP - Volume de Ataques")

cldap_plot_ataq
```


- CLDAP ataque e req

```{r}

g = arrangeGrob(cldap_plot_ataq, cldap_plot_req, nrow=2)

ggsave(file = paste(plots_path, "/cldap_ataques_requisicoes_2plots_W18H14.pdf", sep=""), g, width = 18, height = 14)
ggsave(file = paste(plots_path, "/cldap_ataques_requisicoes_2plots_W18H10.pdf", sep=""), g, width = 18, height = 10)
ggsave(file = paste(plots_path, "/cldap_ataques_requisicoes_2plots_W18H8.pdf", sep=""), g, width = 18, height = 8)
ggsave(file = paste(plots_path, "/cldap_ataques_requisicoes_2plots_W18H6.pdf", sep=""), g, width = 18, height = 6)

grid.arrange(cldap_plot_ataq, cldap_plot_req, nrow=2)
```

- Ataques com muitas requisições em 2020/3

- CLDAP Novas Vítimas
```{r}

data_cldap_period_new_victim = data_cldap %>%
  ungroup() %>%
  group_by(vitima_ip) %>%
  summarise(year_period = min(year_period)) %>%
  ungroup() %>%
  group_by(year_period) %>%
  summarise(new_victims = n_distinct(vitima_ip)) %>%
  mutate(year_period=as.factor(year_period))

```

- CLDAP Plot Novas Vítimas
```{r fig.width = 16, fig.height=12}

data_cldap_period_new_victim %>%
  mutate(
    year_period = paste(substr(year_period, 0, 4), substr(year_period, 5, 5), sep = "/"),
  ) %>%
  ggplot( aes(x=year_period, y=new_victims)) +
    geom_bar(stat="identity", width = 0.8, position="dodge") +
    geom_text(aes(label = addUnits(new_victims),  vjust = -0.25)) +
    scale_fill_viridis(discrete=TRUE) +
    scale_y_continuous(labels = addUnits) +
    ylab("Quantidade de novas vítimas") +
    xlab("Período (Trimestre)") +
    theme(
      plot.title = element_text(size = 22),
      axis.title = element_text(size = 18),
      legend.position="none",
      strip.text = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16),
    ) +
    ggtitle("CLDAP - Novas Vítimas")
```


- Uma grande quantidade de novas vítimas para 2020/4 em relação a quantidade de ataques/requisições

- Coap payload

```{r}

data_cldap_payload %>%
  mutate(is_object_class = grepl('object', payload)) %>%
  group_by(year_period, is_object_class) %>%
  summarise(ataques = n(), requests = sum(requests_per_attack)) %>%
  ungroup() %>%
  group_by(year_period) %>%
  mutate(
    total_period_ataques = sum(ataques),
    total_period_requests = sum(requests)
    ) %>%
  mutate(percentage_ataques = (ataques*100) / total_period_ataques,
         percentage_requests = (requests*100) / total_period_requests) %>%
  select(year_period, is_object_class, ataques, percentage_ataques, requests, percentage_requests)




data_cldap_payload %>%  
  count(payload) %>%
  select('n', 'payload') %>%
  arrange(desc(n))

data_cldap_payload %>%
  mutate(grepl('object', payload))

# total 5,330,991
# 2,755,686 old 51,69%^
# 5330984
# (5330984*100)/5330991 = 99,99



# QOTD e Chargen
```

