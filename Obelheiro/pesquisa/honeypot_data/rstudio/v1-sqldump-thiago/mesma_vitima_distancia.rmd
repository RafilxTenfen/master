---
title: "mesma_vitima_distancia.rmd"
author: "Rafilx"
date: "`r Sys.Date()`"
output: html_document
---

```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library(dplyr)
require(gridExtra)
library(tibble)
library(tidyr)
library(viridis)
library(lubridate)
library(blob)
library(scales)
library(ggrepel)
# library(ggpubr)
# install.packages("ggpubr")
# library("dplyr.teradata")
```
```{r echo=FALSE}
addUnits <- function(n) {
  labels <- ifelse(n < 1000, n, # less than thousands
    ifelse(n < 1e6, paste0(round(n/1e3), 'k'), # in thousands
      ifelse(n < 1e9, paste0(round(n/1e6, 1), 'M'), # in millions
        ifelse(n < 1e12, paste0(round(n/1e9, 2), 'B'), # in billions
          ifelse(n < 1e15, paste0(round(n/1e12, 3), 'T'), # in trillions
  'too big!')))))
  return(labels)
}

addUnitMeses <- function(n){
  return(paste(n, "meses"))
}

minutes = 60
hours = minutes * 60
days = hours * 24
months = days * 30
years = months * 12

addUnitsHours <- function(n) {
  labels <- ifelse(n < minutes, n, # less than 60
    ifelse(n < hours, paste0(round(n/minutes), 'Min'), # in hours
      ifelse(n < months, paste0(round(n/hours, 1), 'Horas'), # in millions
        ifelse(n < years, paste0(round(n/months, 2), 'Meses'), # in billions
          ifelse(n < 1e15, paste0(round(n/years, 3), 'Anos'), # in trillions
  'too big!')))))
  return(labels)
}


labelBiggerThan9 <- function(n){
  labels <- ifelse(n > 9, paste(round(n, 2), "%"), "")
  return(labels)
}

add_percentage <- function(n){
  labels <- paste(round(n, 2), "%")
  return(labels)
}


safe_colorblind_palette <- c("#88CCEE", "#CC6677", "#DDCC77", "#117733", "#332288", "#AA4499",
                             "#44AA99", "#999933", "#882255", "#661100", "#6699CC", "#888888")
minimum_percentage_as_others = 5
decimals_digits = 2

plots_path = "/home/rafilx/projects/github.com/RafilxTenfen/master/Obelheiro/pesquisa/honeypot_data/rstudio/v1-sqldump-thiago/plots"
```


```{r}
db_mix_protocol <- dbConnect(RSQLite::SQLite(), dbname="../../db/database-2022-05-11/mix_protocol.sqlite")

data_mix_protocol_unfetch <-dbSendQuery(db_mix_protocol, "
  SELECT *, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period
    FROM (
      SELECT *,  strftime(\"%Y\", tempo_inicio) as year, ((strftime(\"%m\", tempo_final) - 1) / 3) + 1 AS period
        FROM MIX_PROTOCOL
    )
   WHERE year_period >= 20184 AND
         year_period <= 20221 AND
         requests_per_attack >= 5
")
data_mix_protocol <- fetch(data_mix_protocol_unfetch)

dbDisconnect(db_mix_protocol)
```


- Formatando os timestamp

```{r}
data_mix_protocol['tempo_final_cast'] = as.POSIXct(data_mix_protocol[['tempo_final']], format = "%Y-%m-%d %H:%M:%S")
data_mix_protocol['tempo_inicio_cast'] = as.POSIXct(data_mix_protocol[['tempo_inicio']], format = "%Y-%m-%d %H:%M:%S")
```

```{r}

data_ordered = data_mix_protocol %>%
  arrange(desc(vitima_ip), tempo_inicio_cast) 

count = count(data_ordered)$n
# count = 10

data_ordered['time_diff'] = 0
pos_vitima = 6
pos_time_inicio = 11
pos_time_fim = 12
pos_time_diff = 13


time_diff = 0

for (i in 2:count) {
  # cur_vitima = data_ordered[[pos_vitima]][i]
  # previous_vitima = data_ordered[[pos_vitima]][i-1]
  
  if (data_ordered[[pos_vitima]][i] == data_ordered[[pos_vitima]][i-1]) {
    # previous_time = data_ordered[[pos_time_fim]][i-1]
    # cur_time = data_ordered[[pos_time_inicio]][i]  
    data_ordered[[pos_time_diff]][i] = data_ordered[[pos_time_inicio]][i]  - data_ordered[[pos_time_fim]][i-1]
  } 
}
```


