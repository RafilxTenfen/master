---
title: "mix_protocols traffic volume"
author: "Rafilx"
date: '2022-07-11'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library(dplyr)
require(gridExtra)
library(tibble)
library(viridis)
library(lubridate)
library(blob)
# library("dplyr.teradata")
```

## R Markdown

Analisar a porcentagem de equisições por protocolo, dividindo por períodos. Essa análise não envolve os payloads, apenas os quantitativos de requisições.

Resultados esperados:

- gráficos de linhas e de barras mostrando a evolução 
```{r fetch_data}
db <- dbConnect(RSQLite::SQLite(), dbname="../db/database-2022-05-11/mix_protocol.sqlite")

data_unfetch <-dbSendQuery(db, "
  SELECT *, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period
    FROM (
      SELECT *,  strftime(\"%Y\", tempo_inicio) as year, ((strftime(\"%m\", tempo_final) - 1) / 3) + 1 AS period
        FROM MIX_PROTOCOL
    )
")
data <- fetch(data_unfetch)

dbDisconnect(db)
```
<!-- - Agrupamento realizado por período (trimestre) e "attack_protocol" é o protocolo utilizado no ataque `["chargen", "cldap", "coap", "dns", "memcached", "ntp", "qotd", "ssdp", "steam_games", "outros"]` -->
<!-- - Somando a quantidade de requisições utilizadas por cada protocolo e período -->


```{r}

data['tempo_final_cast'] = as.POSIXct(data[['tempo_final']], format = "%Y-%m-%d %H:%M:%S")
data['tempo_inicio_cast'] = as.POSIXct(data[['tempo_inicio']], format = "%Y-%m-%d %H:%M:%S")

minimum_percentage_as_others = 5
decimals_digits = 2

```

- Agrupamento por trimestre

```{r}
data_grouped_period = data %>%
  mutate(year_period_int = year_period, 
         vitima_ip = as.factor(vitima_ip),
         year_period = as.factor(year_period)) %>%
  group_by(year_period) %>%
  summarise(sum_requests_per_attack = sum(requests_per_attack), 
            number_of_attacks = n(),
            count_victim = n_distinct(vitima_ip)) 

data_grouped_period_percentage = data_grouped_period %>%
  ungroup() %>%
  group_by() %>%
  summarise(year_period = year_period,
            number_of_attacks = number_of_attacks,
            sum_requests_per_attack = sum_requests_per_attack,
            count_victim = count_victim,
            sum_count_victim = sum(count_victim), 
            sum_all_number_of_attacks = sum(number_of_attacks), 
            sum_all_requests_per_attack = sum(sum_requests_per_attack)) %>%
  mutate(number_of_attacks_percentage = (number_of_attacks / sum_all_number_of_attacks) * 100, 
         number_of_requests_percentage = (sum_requests_per_attack / sum_all_requests_per_attack) * 100,
         number_of_victim_percentage = (count_victim / sum_count_victim) * 100)

data_grouped_period_percentage_selected = data_grouped_period_percentage %>%
  select('year_period', 'number_of_attacks_percentage', 'number_of_requests_percentage', 'number_of_victim_percentage')

# data_grouped_period_percentage = data_grouped_period_protocol_percentage %>%
#   mutate(
#     attack_protocol = case_when(
#       number_of_requests_percentage < minimum_percentage_as_others ~ "OUTROS",
#       TRUE ~ as.character(attack_protocol) 
#     )
#   ) %>%
#   group_by(year_period, attack_protocol) %>%
#   summarise(number_of_requests_percentage = sum(number_of_requests_percentage)) 

```

- Todos os trimestres em porcentagem
```{r}

data_grouped_period_percentage_selected %>%
  mutate(number_of_attacks_percentage = round(number_of_attacks_percentage, 2),
         number_of_requests_percentage = round(number_of_requests_percentage, 2),
         number_of_victim_percentage = round(number_of_victim_percentage, 2)) %>%
  rename(attacks = number_of_attacks_percentage, 
         requests = number_of_requests_percentage,
         victim = number_of_victim_percentage) %>%
  print(n=17)
```

- Total de requisições por trimestre
```{r fig.width = 12} 
data_grouped_period_percentage_selected %>%  
  ggplot( aes(x=year_period, y=number_of_requests_percentage)) + 
  geom_bar(stat="identity", width = 0.8, position="dodge") +  
  geom_text(aes(label = paste(round(number_of_requests_percentage, decimals_digits), "%"),  vjust = -0.25)) + 
  scale_fill_viridis(discrete=TRUE) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +  
  ylab("Porcentagem da quantidade de requisições") + 
  xlab("Período (Trimestre)") +  
  ggtitle("Volume de tráfego de requisições") 
```
- Total de ataques por trimestre
```{r fig.width = 12} 
data_grouped_period_percentage_selected %>%  
  ggplot( aes(x=year_period, y=number_of_attacks_percentage)) + 
  geom_bar(stat="identity", width = 0.8, position="dodge") +  
  geom_text(aes(label = paste(round(number_of_attacks_percentage, decimals_digits), "%"),  vjust = -0.25)) + 
  scale_fill_viridis(discrete=TRUE) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +  
  ylab("Porcentagem da quantidade de ataques") + 
  xlab("Período (Trimestre)") +  
  ggtitle("Volume de tráfego de ataques") 
```

- Total de vítimas distintas por trimestre
```{r fig.width = 12} 
data_grouped_period_percentage_selected %>%  
  ggplot( aes(x=year_period, y=number_of_victim_percentage)) + 
  geom_bar(stat="identity", width = 0.8, position="dodge") +  
  geom_text(aes(label = paste(round(number_of_victim_percentage, decimals_digits), "%"),  vjust = -0.25)) + 
  scale_fill_viridis(discrete=TRUE) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +  
  ylab("Porcentagem da quantidade de vítimas distintas no trimestre") + 
  xlab("Período (Trimestre)") +  
  ggtitle("Volume de vítimas distintas por trimestre") 
```
