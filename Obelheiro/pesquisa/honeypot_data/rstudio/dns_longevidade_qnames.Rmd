---
title: 'DN2. DNS: longevidade de nomes'
author: "Rafilx"
date: '2022-05-02'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library(dplyr)
library(tibble)
library(viridis)
library(lubridate)
```

## R Markdown
A longevidade de um nome (QNAME+QTYPE) no dataset pode ser definida como o intervalo entre a primeira e a última aparição desse nome. Calcular a longevidade dos nomes no dataset, e analisar como essa variável está distribuída.

Resultados esperados:

- análise gráfica da distribuição (histograma, ECDF) e numérica (min, max, média, mediana) da longevidade dos nomes
    * por enquanto não vejo sentido em dividir a análise por período, então pode considerar o dataset como um todo
    * minha intuição é que a distribuição seja assimétrica com (longa) cauda à direita

- Busca os dados no banco com o parse do DNS ja realizado, então temos:
  - qname que é o domínio 
  - QTYPE tipo da query
  - query_id ID da transação definido pelo atacante
  - year_period ano e trimestre em que ocorreu o ataque exemplo "20212" o ataque ocorreu no segundo trimestre do 2021
  
```{r fetch_data}
db <- dbConnect(RSQLite::SQLite(), dbname="../dnstor_statistics_dns.sqlite")

data_unfetch <-dbSendQuery(db, "  
  SELECT *, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period
    FROM DNS_ANALYSIS
		JOIN DNS_ANALYSIS_QUESTION
		  ON DNS_ANALYSIS.id = DNS_ANALYSIS_QUESTION.dns_analysis_id
	 WHERE QTYPE != 0
")
data <- fetch(data_unfetch)

dbDisconnect(db)
```

```{r}
data['tempo_final_cast'] = as.POSIXct(data[['tempo_final']], format = "%Y-%m-%d %H:%M:%S")
data['tempo_inicio_cast'] = as.POSIXct(data[['tempo_inicio']], format = "%Y-%m-%d %H:%M:%S")

secs_to_month = (60 * 60 * 24 * 30)

data_grouped = data %>%
  group_by(qname, qtype) %>%
  summarise(tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast), sum_requests_per_attack=sum(requests_per_attack)) %>%
  mutate(tempo_diff_secs = as.numeric(tempo_final - tempo_inicio, units="secs"), tempo_diff = tempo_final - tempo_inicio) %>%
  #filter(tempo_diff > 0) %>%
  arrange(desc(tempo_diff_secs))
  
data_grouped %>%
  head(10)
```

```{r}
data_grouped %>%
  ggplot(aes(x= tempo_diff_secs)) +
  geom_histogram(bins = 10, fill='blue', color ='black') +
  ggtitle("Longevidade de um mesmo (QNAME + QTYPE)") + 
  xlab("tempo_final - tempo_inicio") + 
  theme_classic()
```

```{r}
data_grouped %>%
  ggplot(aes(x= tempo_diff_secs)) +
  stat_ecdf(geom = "step", pad = FALSE) +
  ggtitle("Longevidade de um mesmo (QNAME + QTYPE)") + 
  xlab("tempo_final - tempo_inicio") + 
  theme_classic()
```

```{r}

data_grouped.tempo_diff_secs.min = min(data_grouped$tempo_diff_secs)
data_grouped.tempo_diff_secs.max = max(data_grouped$tempo_diff_secs)
data_grouped.tempo_diff_secs.mean = mean(data_grouped$tempo_diff_secs)
data_grouped.tempo_diff_secs.median = median(data_grouped$tempo_diff_secs)

quantile(data_grouped$tempo_diff_secs)
summary(data_grouped)
```

- Dados sobre o intervalo entre a primeira e a última aparição desse (QNAME+QTYPE) 
  - Mínimo `r data_grouped.tempo_diff_secs.min` segundos
  - Máximo `r data_grouped.tempo_diff_secs.max / secs_to_month` meses
  - Média `r data_grouped.tempo_diff_secs.mean / 60` minutos
  - Mediana `r data_grouped.tempo_diff_secs.median` segundos


```{r}
trim_value = .30

data_grouped.tempo_diff_secs.min = min(data_grouped$tempo_diff_secs, trim=trim_value)
data_grouped.tempo_diff_secs.max = max(data_grouped$tempo_diff_secs, trim=trim_value)
data_grouped.tempo_diff_secs.mean = mean(data_grouped$tempo_diff_secs, trim=trim_value)
data_grouped.tempo_diff_secs.median = median(data_grouped$tempo_diff_secs, trim=trim_value)

quantile(data_grouped$tempo_diff_secs, trim=trim_value)
summary(data_grouped, trim=trim_value)
```

- Dados sobre o intervalo entre a primeira e a última aparição do (QNAME+QTYPE) removendo `r trim_value * 100`% dos valores máximos e mínimos 
  - Mínimo `r data_grouped.tempo_diff_secs.min` segundos
  - Máximo `r data_grouped.tempo_diff_secs.max / secs_to_month` meses
  - Média `r data_grouped.tempo_diff_secs.mean/ (60)` minutos
  - Mediana `r data_grouped.tempo_diff_secs.median` segundos
  
- Identificar qual é o percentil em que há essa mudança de tendência (próximo aos 72-73%) e qual a duração correspondente
```{r}
quantile(data_grouped$tempo_diff_secs, 
          c(.5332, .6235, .696282, .710307, .72, .7204, 
            .721090026, .73, .7396902445, .75, .76, 
            .77, .78, .99))
```
- Isso representa que Y% dos (QNAME+TYPE), tem os seus ataques com duração de até X segundos:
  - 53.3%  até 100 segundos
  - 62.3%  até 1000 segundos
  - 69.6%  até 10000 segundos
  - 71%    até 100000 segundos
  - 72%    até 598289 segundos
  - 72.04% até 803076 segundos
  - 72.11% até 1000000 segundos
  - 73.97% até 10000000 segundos
- Significa que após os 69% o tempo dos ataques cresce muito até cerca de 73.97% onde estabiliza próximo dos 10000000 segundos

- Uma representação ECDF removendo os registros abaixo da quantidade de segundos em que apresenta estabilidade (10000000 segundos) 
  - Possívelmente apresenta uma distribuição assimétrica com cauda a direita

```{r}
data_grouped %>%
  filter(tempo_diff_secs > 10000000) %>%
  ggplot(aes(x= tempo_diff_secs)) +
  stat_ecdf(geom = "step", pad = FALSE) +
  ggtitle("Longevidade de um mesmo (QNAME + QTYPE)") + 
  xlab("tempo_final - tempo_inicio") + 
  theme_classic()
```

```{r}

percentage_76_secs = quantile(data_grouped$tempo_diff_secs, c(.76))[[1]]
percentage_76_secs/secs_to_month

percentage_99_secs = quantile(data_grouped$tempo_diff_secs, c(.995))[[1]]
percentage_99_secs/secs_to_month

data_grouped.tempo_diff_secs.max / secs_to_month
```

- Cerca de 24% dos (QNAME + QTYPE) possuem uma longevidade entre 9 e 16 meses 
```{r}

data_grouped %>%
  filter(tempo_diff_secs > percentage_76_secs) %>%
  ggplot(aes(x= tempo_diff_secs / secs_to_month)) +
  geom_histogram(bins = 50, fill='blue', color ='black') +
  ggtitle("Longevidade de um mesmo (QNAME + QTYPE)") + 
  xlab("Meses de Longevidade") + 
  theme_classic()
```
```{r}

data_bigger_than_76 = data_grouped %>%
  filter(tempo_diff_secs > percentage_76_secs) %>%
  ungroup() %>%
  group_by(qtype) %>%
  summarise(qtype_quantity = n()) %>%
  arrange(desc(qtype_quantity))
  
  
sum_qtype_quantity = sum(data_bigger_than_76$qtype_quantity)
data_bigger_than_76_percentage = data_bigger_than_76 %>%
  mutate(qtype_quantity_percentage = (qtype_quantity / sum_qtype_quantity) * 100) 

data_bigger_than_76_percentage

```

```{r fig.align="center", fig.width = 10}
data_bigger_than_76_percentage %>%
 ggplot( aes(x=reorder(qtype, +qtype_quantity_percentage), y=qtype_quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_viridis(discrete=TRUE, name="") +
    geom_text(aes(label = paste(round(qtype_quantity_percentage, 2), "%")), vjust = -0.10, ) + 
    theme_classic() + 
    ylab("Porcentagem da quantidade") +
    xlab("QTYPE") +
    ggtitle("QTYPE com longevidade entre 9 e 16 meses")
    
```
- Então dos QTYPE que possuem uma alta longevidade entre 9 e 16 meses (cerca de 24% de todos os registros 76% ~ 100%) 
  - 20% (`r data_bigger_than_76_percentage[(data_bigger_than_76_percentage['qtype'] == "MX"),]$qtype_quantity`) deles possuem o QTYPE "MX" 
  - 78% (`r data_bigger_than_76_percentage[(data_bigger_than_76_percentage['qtype'] == "A"),]$qtype_quantity`) dos ataques com maior longevidade utilizam o QTYPE "A", o que é surpreendente
  - E por fim o QTYPE "ANY" aparece com apenas `r data_bigger_than_76_percentage[(data_bigger_than_76_percentage['qtype'] == "ANY"),]$qtype_quantity` registros de QTYPE com longevidade entre 9 e 16 meses


```{r}

percentage_76_secs_A_qnames = data_grouped %>%
  filter(tempo_diff_secs > percentage_76_secs) %>%
  filter(qtype == "A") %>%
  select(qname) %>%
  distinct(qname)
  

percentage_76_secs_qtype_A = data %>%
  filter(qtype == "A") %>%
  filter(qname %in% percentage_76_secs_A_qnames$qname)
```


- O QTYPE "A" é o QTYPE que possui a maior quantidade de QNAMEs com alta longevidade entre 9 e 16 meses
  - Esse é o top 10 de QTYPE A agroupado por QNAME representado por qname_count e somado o request_per_attack 
```{r}
percentage_76_secs_qtype_A_group_qname = percentage_76_secs_qtype_A %>%
  group_by(qname) %>%
  summarise(qname_count = n(), sum_requests_per_attack=sum(requests_per_attack), tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast), sum_requests_per_attack=sum(requests_per_attack)) %>%
  mutate(tempo_diff_secs = as.numeric(tempo_final - tempo_inicio, units="secs"), tempo_diff = tempo_final - tempo_inicio) 

percentage_76_secs_qtype_A_group_qname %>%
  arrange(desc(tempo_diff_secs)) %>%
  head(10)
```

- Uníca coisa a ressaltar aqui é que o top 1 QNAME "whoami.akamai.net." que apareceu 3639x e foi o registro com maior longevidade 480 dias, cerca de 16 meses

- Ao ordenar pela soma de requests por ataque o top 10 muda
```{r}
percentage_76_secs_qtype_A_group_qname %>%
  arrange(desc(sum_requests_per_attack)) %>%
  head(10)
```

- Nenhum dos registros ordenados pela quantidade de requisições por ataque está no top 10 ordenado pela longevidade dos dados

- Para verificar se o mesmo query_id é muito utilizado foi agrupado somente por query_id 
```{r}

percentage_76_secs_qtype_A %>%
  group_by(query_id) %>%
  summarise(query_id_count = n(), sum_requests_per_attack=sum(requests_per_attack), tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast), sum_requests_per_attack=sum(requests_per_attack)) %>%
  mutate(tempo_diff_secs = as.numeric(tempo_final - tempo_inicio, units="secs"), tempo_diff = tempo_final - tempo_inicio) %>%
  arrange(desc(query_id_count)) %>%
  head(10)


```
- Nada chamou a atenção






#### Registros separados por trimestre

```{r}
#N = 10


#data_split_year_period = data %>%
#  group_split(year_period)


#period_query_id_qname = data.frame()
#for (i in c(1:length(data_split_year_period))) {
#  query_id_qname_frequency = data_split_year_period[[i]] %>%
#    group_by(qname, qtype) %>%
#    summarise(tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast), sum_requests_per_attack=sum(requests_per_attack), year_period=year_period) %>%
#    mutate(tempo_diff_secs = as.numeric(tempo_final - tempo_inicio, units="secs"), tempo_diff = tempo_final - tempo_inicio) %>%
#    arrange(desc(tempo_diff_secs))
#  
#  period_query_id_qname = rbind(period_query_id_qname, head(query_id_qname_frequency, N))
#}
```

- Apenas verificando as porcentagens de QTYPE por trimestre 
```{r}

data %>%
  group_by(year_period, qtype) %>%
  summarise(sum_grouped_year_period_qtype = n()) %>%
  group_by(year_period) %>%
  mutate(sum_qtype_year_period = sum(sum_grouped_year_period_qtype), qtype_percentage = ((sum_grouped_year_period_qtype/sum_qtype_year_period) * 100) ) %>%
  arrange(desc(qtype_percentage)) %>% 
  head(10)
``` 

- Agrupa os dados por (qname, qtype, year_period) para calcular por trimestre a longevidade dos registros com o mesmo QNAME+QTYPE 
  - OBS.: Inicialmente eu iria verificar a longevidade, mas não faz sentido então separar por trimestre para verificar o quanto um qname se manteve ativo dentro do trimestre, correto? @Obelheiro @Thiago
```{r}
data_year_period = data %>%
  group_by(qname, qtype, year_period) %>%
  summarise(tempo_inicio=min(tempo_inicio_cast), tempo_final=max(tempo_final_cast), sum_requests_per_attack=sum(requests_per_attack)) %>%
  mutate(year_period=as.factor(year_period), tempo_diff_secs = as.numeric(tempo_final - tempo_inicio, units="secs"), tempo_diff = tempo_final - tempo_inicio) %>%
  arrange(desc(tempo_diff_secs)) 
  
```

- Agrupa somente pelo trimestre e o QTYPE para calcular quantos qnames diferentes existem em cada QTYPE

```{r}
data_year_period_qtype_quantity = data_year_period %>%
  ungroup() %>%
  group_by(year_period, qtype) %>%
  summarise(qtype_quantity = n())
```

- Calcular a porcentagem da quantidade QTYPE 
```{r}
data_year_period_qtype_quantity_percentage = data_year_period_qtype_quantity %>%
  group_by(year_period) %>%
  mutate(sum_qtype_quantity_year_period = sum(qtype_quantity), qtype_year_period_quantity_percentage=((qtype_quantity/sum_qtype_quantity_year_period) * 100))

```

```{r fig.width = 12}
data_year_period_qtype_quantity_percentage %>% 
  filter(qtype_year_period_quantity_percentage > 1) %>%
  ggplot( aes(x=year_period, y=qtype_year_period_quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", width = 0.55) +
    geom_text(aes(label = paste(round(qtype_year_period_quantity_percentage, 2), "%")), position = position_stack(vjust = 0.6)) +
    scale_fill_viridis(discrete=TRUE, direction = -1) +
    ylab("Porcentagem de QNAMES diferentes no trimestre") +
    xlab("Trimestre") +
    ggtitle("Quantidade de QNAMES diferentes em cada QTYPE no trimestre")

```

- Isso mostra que o QTYPE "A" tem uma grande quantidade de ataques com QNAMES distintos em cada trimestre
