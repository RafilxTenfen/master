---
title: "dns_achados"
author: "Rafilx"
date: '2022-04-14'
output:
  pdf_document: default
  html_document: default
---

## R Markdown


<!-- - Executar as seguintes availiações por quarter -->
<!--   - verificar se o mesmo queryid existe por vários periodos -->
<!--   - verificar se o mesmo qname aparece por vários periodos -->
<!--   - olhar as tabelas antes de plotar -->
<!--   - Olhar o período passado para verificar o surgimento de novos casos de qname / query_id -->
<!--   - verificar se tirar ou não o " HAVING qnt_repeat_query_id > 1" -->
<!--   - quero gráficos de barra -->
<!--   - group por qname, qtype e queryid para verificar a ocorrência de grupo de ataques -->

<!-- verificar rfc1034,1035 para queryid repetidos -->


```{r echo=FALSE}
library('RSQLite')
library('ggplot2')
library(DBI)
options("scipen"=100, "digits"=4)
library(dplyr)
library(tibble)
library(viridis)
library(lubridate)
```


- Busca os dados no banco com o parse do DNS ja realizado, então temos:
  - qname que é o domínio 
  - qtype tipo da query
  - query_id ID da transação definido pelo atacante
  - year_period ano e trimestre em que ocorreu o ataque exemplo "20212" o ataque ocorreu no segundo trimestre do 2021
```{r fetch_data}
db <- dbConnect(RSQLite::SQLite(), dbname="./dnstor_statistics_dns.sqlite")

data_unfetch <-dbSendQuery(db, "  
  SELECT *, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period
    FROM DNS_ANALYSIS
		JOIN DNS_ANALYSIS_QUESTION
		  ON DNS_ANALYSIS.id = DNS_ANALYSIS_QUESTION.dns_analysis_id
	 WHERE QTYPE != 0
")
data <- fetch(data_unfetch)

dns_data_unfetch <- dbSendQuery(db, "  
  SELECT count(*) as countGrouped, year, period, CAST(CAST(year AS text) || CAST(period AS text) as integer) as year_period , qname, qtype, SUM(requests_per_attack) as quantity
    FROM DNS_ANALYSIS
    JOIN DNS_ANALYSIS_QUESTION
      ON DNS_ANALYSIS.id = DNS_ANALYSIS_QUESTION.dns_analysis_id
   WHERE QTYPE != 0
GROUP BY year_period, year, period, qname, qtype
ORDER BY quantity DESC;
")
dns_data_fetched <- fetch(dns_data_unfetch)

dns_data_overlap_unfetch <- dbSendQuery(db, "  
   SELECT * 
     FROM TB_DATE_OVERLAP_QUERYID
 ORDER BY amount_overlap;
")
dns_data_overlap_fetched <- fetch(dns_data_overlap_unfetch)

dbDisconnect(db)
```


- Primeiro separa todos os registros por trimestre
```{r}
data_split_year_period = data %>%
  group_split(year_period)
```

- Gerando um total de `r length(data_split_year_period)` trimestres 
```{r}
N=10

period_query_id = data.frame()
for (i in c(1:length(data_split_year_period))) {
  query_id_frequency = data_split_year_period[[i]] %>%
    count(query_id) 
  
  query_id_frequency['year_period'] = data_split_year_period[[i]]$year_period[1]
  
  period_query_id = rbind(period_query_id, head(query_id_frequency[order(-query_id_frequency$n),], N) )
}
```

### Os `r N` query_id mais utilizados divididos por período e ordenados pela frequência em que apareceram no período

```{r}
period_query_id %>%
  group_split(year_period)
```
- Dessa forma é possível observar que o mesmo query_id é utilizado várias vezes durante o mesmo trimestre, como no primeiro trimestre de 2021 que o query_id 17767 foi utilizado em 67047 ataques

<!-- - Os query_id que mais aparecem no top `r N` em cada trimestre -->
<!-- ```{r} -->
<!-- period_query_id %>% -->
<!--   count(query_id) %>% -->
<!--   filter(n > 1) %>% -->
<!--   arrange(desc(n)) -->
<!-- ``` -->


### Os `r N` query_id mais utilizados 
```{r}
data %>%
  count(query_id) %>%
  arrange(desc(n)) %>%
  head(N)
```

### Os `r N` query_id mais utilizados em cada período ordenados pela frequência em que apareceram levando em consideração todos os períodos
```{r}
period_query_id %>%
  arrange(desc(n)) %>%
  head(N)
```


### Os query_id que apareceram com maior frequência entre os top `r N` em todos os períodos
- Caso o query_id 13213 fosse top 1 em 20204 e top 3 em 20211 e não aparecer em mais nenhum outro período seu "n" seria 2

```{r}
period_query_id %>%
  count(query_id) %>%
  arrange(desc(n)) %>%
  filter(n > 1)
```
- Isso apresenta que um mesmo query_id esteve no top `r N` em "n" trimestres diferentes, o que levanta a possibilidade de que atacantes diferentes possam estar utilizando a mesma ferramenta para realizar ataques

### Dados agrupados por qname, query_id, período e qtype

```{r}
period_query_id_qname = data.frame()
for (i in c(1:length(data_split_year_period))) {
  query_id_qname_frequency = data_split_year_period[[i]] %>%
    count(qname, qtype, query_id, year_period, sort = TRUE) %>%
    filter(n > 1)   
  
  period_query_id_qname = rbind(period_query_id_qname, head(query_id_qname_frequency, N) )
}
```


### Os `r N` query_id, qname, qtype mais utilizados divididos por período e ordenados pela frequência em que apareceram no período

```{r}
period_query_id_qname %>%
  group_split(year_period)
```
- Ao observar esses registros, é possível verificar que alguns deles se repetem durante o tempo utilizando o mesmo qname, qtype e query_id, e que possívelmente não fizeram nenhuma alteração na ferramenta de ataque durante o período observado que iniciou no ultimo trimestre de 2020 até o primeiro trimestre de 2022.

### Os query_id que apareceram com maior frequência entre os top `r N` em todos os períodos, agrupados por qname e qtype
- Caso o query_id 13213 de qname = "isc.org." e qtype = "ANY" fosse top 1 em 20204 e top 3 em 20211 e não aparecer em mais nenhum outro período seu "n" seria 2

```{r}
top_queryid_qname = period_query_id_qname %>%
  count(query_id, qtype, qname) %>%
  arrange(desc(n)) %>%
  filter(n > 1)

top_queryid_qname
```
- O ataque do tipo ANY de qname "sl." e query_id "17767" apareceu no top `r N` 6x, ou seja em todo trimestre esse foi um dos ataques mais realizados que passaram pelos honeypots

### Top `r N` consultas que receberam a maior quantidade de requisições por períodos

```{r}
dns_data.year_period.ungrouped <- group_split(dns_data_fetched, year_period) 

dns_data.topNconsultas <- head(dns_data.year_period.ungrouped[[1]], N)
dns_data.year_period.ungrouped.len = length(dns_data.year_period.ungrouped)

dns_columns = c('year_period', 'qtype', 'quantity', 'qname')
select(dns_data.topNconsultas, dns_columns)
select(head(dns_data.year_period.ungrouped[[2]], N), dns_columns)
select(head(dns_data.year_period.ungrouped[[3]], N), dns_columns)
select(head(dns_data.year_period.ungrouped[[4]], N), dns_columns)
select(head(dns_data.year_period.ungrouped[[5]], N), dns_columns)
select(head(dns_data.year_period.ungrouped[[6]], N), dns_columns)

for (i in c(2:dns_data.year_period.ungrouped.len)) {
  dns_data.topNconsultas <- rbind(dns_data.topNconsultas, head(dns_data.year_period.ungrouped[[i]], N))
}
```


```{r}
## ------------ Quantos ataques com cada tipo de qtype foi utilizado, por trimestre ? ------------
#dns_data_fetched

dns_data_fetched.quarter_type_quantity = select(dns_data_fetched, c('year_period', 'qtype', 'quantity'))

dns_data_fetched.sum_attacks_quarterly = dns_data_fetched.quarter_type_quantity %>%
  group_by(qtype, year_period) %>%
  summarise(quantity = sum(quantity))

#dns_data_fetched.sum_attacks_quarterly %>%
#  mutate(year_period=as.factor(year_period)) %>%
#  ggplot(aes(x = year_period, y = quantity, color = qtype)) +
#  geom_line()

#ggplot(data = dns_data_fetched.sum_attacks_quarterly, aes(x = year_period, y = quantity)) +
#    geom_line() +
#    facet_wrap(facets = vars(qtype))

#dns_data_fetched.sum_attacks_quarterly %>% 
#  filter(qtype != "ANY") %>%
#  ggplot(aes(x = year_period, y = quantity)) +
#    geom_line() +
#   facet_wrap(facets = vars(qtype))

# ------------------------------------------- quantity with percentage



dns_data_fetched.sum_attacks_quarterly.sum_period_quantity = dns_data_fetched.sum_attacks_quarterly %>%
  group_by(year_period) %>%
  summarise(sum_period_quantity = sum(quantity), qtype=qtype, quantity=quantity)

dns_data_fetched.sum_attacks_quarterly.sum_period_quantity['quantity_percentage'] = (dns_data_fetched.sum_attacks_quarterly.sum_period_quantity$quantity * 100) / dns_data_fetched.sum_attacks_quarterly.sum_period_quantity$sum_period_quantity

#dns_data_fetched.sum_attacks_quarterly.sum_period_quantity %>% 
#  filter(quantity_percentage > 0.001) %>%
#  filter(quantity_percentage > 0.1) %>%
  #ggplot(aes(x = year_period, y = quantity_percentage)) +
   # geom_line() +
    #facet_wrap(facets = vars(qtype))


#dns_data_fetched.sum_attacks_quarterly.sum_period_quantity %>% 
#  filter(qtype != "ANY") %>%
#  ggplot(aes(x = year_period, y = quantity_percentage)) +
#    geom_line() +
#    facet_wrap(facets = vars(qtype))

#dns_data_fetched.sum_attacks_quarterly.sum_period_quantity %>%
  #mutate(year_period=as.factor(year_period)) %>%
#  filter(quantity_percentage > 0.1) %>%
#  ggplot(aes(x = year_period, y = quantity_percentage, color = qtype)) +
#  geom_line()

# ------------------------------------------- filter any

dns_data_fetched.sum_attacks_quarterly.sum_period_quantity.filter_any = dns_data_fetched.sum_attacks_quarterly %>%
  group_by(year_period) %>%
  filter(qtype != "ANY") %>%
  summarise(sum_period_quantity = sum(quantity), qtype=qtype, quantity=quantity)

dns_data_fetched.sum_attacks_quarterly.sum_period_quantity.filter_any['quantity_percentage'] = (dns_data_fetched.sum_attacks_quarterly.sum_period_quantity.filter_any$quantity * 100) / dns_data_fetched.sum_attacks_quarterly.sum_period_quantity.filter_any$sum_period_quantity

#dns_data_fetched.sum_attacks_quarterly.sum_period_quantity.filter_any %>% 
#  ggplot(aes(x = year_period, y = quantity_percentage)) +
#    geom_line() +
#    facet_wrap(facets = vars(qtype))

```

- A quantidade de requests em % por trimestre por qtype
```{r}
dns_data_fetched.sum_attacks_quarterly.sum_period_quantity %>% 
  ggplot(aes(x = year_period, y = quantity_percentage)) +
    geom_line() +
    facet_wrap(facets = vars(qtype))
```


- A quantidade de requests em % por trimestre por qtype
  - lembrando que em 20213 teve um problema em armazenar os dados, por isso talvez essa discrepância
```{r}
dns_data_fetched.sum_attacks_quarterly.sum_period_quantity %>%
  #mutate(year_period=as.factor(year_period)) %>%
  filter(quantity_percentage > 0.1) %>%
  ggplot(aes(x = year_period, y = quantity_percentage, color = qtype)) +
  geom_line()
```
- Com esse gráfico é possível observar a grande quantidade de ataques do tipo ANY sendo extremamente superior aos demais, até mesmo no trimestre em que houve problema de armazenamento e alguns registros foram perdidos

- Quantos qnames e qtypes novos aparecem em cada trimestre

```{r}

# ------------ Quantos qtypes novos aprecem em cada trimestre ------------
# > Diferenças percentuais são mais relevantes que absolutas

quarter_qtype_aux = dns_data.year_period.ungrouped[[1]] %>%
  group_by(qtype) %>%
  summarise(quantity = sum(quantity))

#quarter_qtype_2 = dns_data.year_period.ungrouped[[2]] %>%
#  group_by(qtype) %>%
#  summarise(quantity = sum(quantity))

#quarter_qtype_2
#merged = merge(x = quarter_qtype_aux, y = quarter_qtype_2, by = "qtype", all = TRUE)
#merged.new_quantity = merged$quantity.x - merged$quantity.y
#merged

quarter_new_qtype = data.frame()
for (i in c(2:dns_data.year_period.ungrouped.len)) {
  quarter_qtype = dns_data.year_period.ungrouped[[i]] %>%
    group_by(qtype) %>%
    summarise(quantity = sum(quantity))
  
  merged = merge(x = quarter_qtype_aux, y = quarter_qtype, by = "qtype", all = TRUE)
  merged.new_quantity = merged$quantity.x - merged$quantity.y
  
  perio_to_period = paste(head(dns_data.year_period.ungrouped[[i - 1]]['year'], 1), '.',  head(dns_data.year_period.ungrouped[[i - 1]]['period'], 1), '->' , head(dns_data.year_period.ungrouped[[i]]['year'], 1), '.', head(dns_data.year_period.ungrouped[[i]]['period'], 1))
  quarter_new_qtype <- rbind(quarter_new_qtype, data.frame(quarter_to_quarter=perio_to_period, merged$qtype, sum_quantity=merged$quantity.y - merged$quantity.x, quantity_percentage=(((merged$quantity.y - merged$quantity.x)*100)/merged$quantity.x), merged$quantity.x, merged$quantity.y))
  
  quarter_qtype_aux = quarter_qtype
}

#quarter_new_qtype
#head(na.omit(quarter_new_qtype[order(-quarter_new_qtype$quantity_percentage),]))

# ------------ Quantos qname novos aprecem em cada trimestre ------------

quarter_qname_aux = dns_data.year_period.ungrouped[[1]] %>%
  group_by(qname) %>%
  summarise(quantity = sum(quantity))

quarter_new_qname = data.frame()
for (i in c(2:dns_data.year_period.ungrouped.len)) {
  quarter_qname = dns_data.year_period.ungrouped[[i]] %>%
    group_by(qname) %>%
    summarise(quantity = sum(quantity))
  
  merged = merge(x = quarter_qname_aux, y = quarter_qname, by = "qname", all = TRUE)
  merged.new_quantity = merged$quantity.x - merged$quantity.y
  
  period_to_period = paste(head(dns_data.year_period.ungrouped[[i - 1]]['year'], 1), '.',  head(dns_data.year_period.ungrouped[[i - 1]]['period'], 1), '->' , ... = head(dns_data.year_period.ungrouped[[i]]['year'], 1), '.', head(dns_data.year_period.ungrouped[[i]]['period'], 1))
  quarter_new_qname <- rbind(quarter_new_qname, data.frame(quarter_to_quarter=period_to_period, merged$qname, sum_quantity=(merged$quantity.y - merged$quantity.x), quantity_percentage_diff=(((merged$quantity.y - merged$quantity.x)*100)/merged$quantity.x), merged$quantity.x, merged$quantity.y))
  
  quarter_qname_aux = quarter_qname
}
#quarter_new_qname
#head(na.omit(quarter_new_qname[-order(quarter_new_qname$quantity_percentage_diff),]))

```


- Top `r N` novos qtypes por trimestre 
```{r}
quarter_new_qtype %>%
  arrange(desc(sum_quantity)) %>%
  select('quarter_to_quarter', 'merged.qtype', 'sum_quantity') %>%
  head(N)
``` 
- Nessa tabela deveriamos desconsiderar todos os registros relacionados ao período 2021.3, então o registro mais relevante é o top 1 que indica que tiveram 17841217 novas requisições do tipo ANY do ultimo trimestre de 2020 para o primeiro trimestre de 2021

- Top `r N` novos qnames por trimestre 
```{r}
quarter_new_qname %>%
  arrange(desc(sum_quantity)) %>%
  select('quarter_to_quarter', 'merged.qname', 'sum_quantity') %>%
  head(N)
``` 
- 

- Gráfico de barras da porcentagem de qtypes por trimestre
```{r}

dns_data_fetched.sum_attacks_quarterly.sum_period = dns_data_fetched.sum_attacks_quarterly %>%
  group_by(year_period) %>%
  summarise(period_quantity = sum(quantity), qtype=qtype, quantity=quantity)

dns_data_fetched.sum_attacks_quarterly.sum_period['quantity_percentage'] = (dns_data_fetched.sum_attacks_quarterly.sum_period$quantity * 100) / dns_data_fetched.sum_attacks_quarterly.sum_period$period_quantity

```

- A porcentagem calculada pela quantidade de requisições em cada período por cada qtype
```{r fig.width = 12}
dns_data_fetched.sum_attacks_quarterly.sum_period %>% 
  mutate(year_period=as.factor(year_period)) %>%
  filter(quantity_percentage > 0.1) %>%
  ggplot( aes(x=reorder(qtype, -quantity_percentage), y=quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", position="dodge") +
    scale_fill_viridis(discrete=TRUE, name="") +
    geom_text(aes(label = paste(round(quantity_percentage, 2), "%")), vjust = +0.25, ) +
    facet_grid(~year_period) +
    ylab("Percentage of attacks") +
    ggtitle("All QTYPES - ungrouped bar")
```

- Novamente a porcentagem calculada pela quantidade de requisições em cada período por cada qtype, cada barra é um trimestre
```{r fig.width = 12}
dns_data_fetched.sum_attacks_quarterly.sum_period %>% 
  mutate(year_period=as.factor(year_period)) %>%
  filter(quantity_percentage > 0.1) %>%
  ggplot( aes(x=year_period, y=quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", width = 0.5) +
    geom_text(aes(label = paste(round(quantity_percentage, 2), "%")), position = position_stack(vjust = 0.1)) +
    scale_fill_viridis(discrete=TRUE, name="") +
    ylab("Percentage of attacks") +
    ggtitle("All QTYPES - stacked bars")
```
- Porcentagem da quantidade de requisições por trimestre por qtype em que tenha no mínimo 1% de requisições totais realizadas 

```{r fig.align="center", fig.width = 12}

## Filter data using qtype quantity percentage bigger than 1

dns_data_fetched.sum_attacks_quarterly.sum_period %>%
  filter(quantity_percentage > 1) %>%
  mutate(year_period=as.factor(year_period)) %>%
  ggplot( aes(x=reorder(qtype, -quantity_percentage), y=quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", position="dodge") +
    geom_text(aes(label = paste(round(quantity_percentage, 2), "%")), vjust = -0.25) +
    facet_grid(~year_period) +
    scale_fill_viridis(discrete=TRUE, name="") +
    ylab("Percentage of attacks") +
    ggtitle("QTYPES > 1% by period - ungrouped bars")

dns_data_fetched.sum_attacks_quarterly.sum_period %>%
  filter(quantity_percentage > 1) %>%
  mutate(year_period=as.factor(year_period)) %>%
  ggplot( aes(x=year_period, y=quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", width = 0.5) +
    geom_text(aes(label = paste(round(quantity_percentage, 2), "%")), position = position_stack(vjust = 0.1)) +
    scale_fill_viridis(discrete=TRUE, name="") +
    ylab("Percentage of attacks") +
    ggtitle("QTYPES > 1% by period - stacked bars")

```
- Com esse gráfico é possível observar a grande quantidade de ataques do tipo ANY sendo extremamente superior aos demais, levando a crer que a depreciação da query do tipo ANY vazia nos servidores DNS não afetou o modo em que os ataques são realizados, até mesmo porque inúmeros servidores DNS não se atualizaram e não depreciaram esse modo de realizar as queries

- Quantidade de requisições por trimestre

```{r}
dns_data_fetched.sum_attacks_quarterly.sum_period %>%
  mutate(year_period=as.factor(year_period)) %>%
  ggplot( aes(x=year_period, y=period_quantity)) +
    geom_bar(stat="identity", width = 0.5) +
    scale_fill_viridis(discrete=TRUE, name="") +
    ylab("Quantity of attacks") +
    ggtitle("Attacks by period")
```
- Em quantidade de ataques, obtivemos um pico no primeiro trimestre de 2021, e logo vamos poder comparar com o primeiro trimestre de 2022 para verificar se geralmente o primeiro trismestre é aquele em que ocorrem a maior quantidade de ataques no ano

- Os `r N` ataques em que tiveram uma maior sobreposição de tempo entre o início e o fim do ataque com um mesmo query_id
```{r}
dns_data_overlap_fetched %>% 
  arrange(desc(amount_overlap)) %>%
  head(5)
```
- Isso possívelmente indica que alguns atacantes utilizaram-se da mesma ferramenta para realizar o ataque para diferentes domínios e nem sequer modificaram o query_id, ou utilizaram algum modo de incremento para ofuscar o ataque

# Texto

## Dados 
- Esse documento teve como dados apenas os ataques que utilizam DNS. Esses ataques foram recolhidos pelo MP-H entre o período de 29/10/2020 até 24/02/2022. 
- Os datasets com os ataques DNS foram processados por um script em python que faz o parse do payload para recolher informações do DNS como:
  - O query_id que é o ID da transação definido pelo atacante; 
  - O qname que é o domínio em que o atacante realizou spoffing; 
  - O qtype que é o tipo da query utilizada para realizar amplificação. 

## Questões
- A ideia para esse documento é realizar uma análise longitudinal da evolução dos payloads somente para evoluções relacionadas a ataques DNS. 
- Uma das analises destacadas é o uso do DNS com o QTYPE ANY. Pois, historicamente ataques DRDoS com DNS utilizam majoritariamente requisições para o QTYPE ANY, que retorna todos os tipos de registros para um dado nome. Assim, será que a incidência de requisições com ANY evoluiu ao longo do tempo? 
- Para contexto, requisições para o QTYPE ANY tem um grande potencial de amplificação e o seu uso legítimo é apenas para debug do servidor, por esse motivo, foi introduzida uma recomendação para que servidores DNS não respondam a consultas com QTYPE ANY (Não encontrei na [RFC1035](https://datatracker.ietf.org/doc/html/rfc1035) ou na [RFC6763](https://www.ietf.org/rfc/rfc6763.txt) :/) para evitar o uso dessas requisições em ataques de negação de serviço.

## Analises
- Obs.: Tenha em mente que os dados referentes ao terceiro trimestre de 2021 podem não refletir a realidade, devido a alguns problemas de armazenamento durante esse período

### Quantidade de requisições por QTYPE e trismestres
- Para realizar a análise, foi realizado uma query agrupando os registros do DNS por (year_period, year, period, qname, qtype) e somado a quantidade de ataques por requisições e chamado de (quantity)
- Dessa forma, foi analisado a porcentagem de cada QTYPE dentre as consultas por trimestre de DNS já processados, em que a porcentagem foi definida pela soma de requisições por ataques de um mesmo tipo. Então por exemplo se em um mesmo trimestre a soma de todas as requisições dos ataques com o QTYPE MX for 20 e somadas todas as requisições dos ataques do tipo ANY for 80, a porcentagem de ANY será 80% e de MX será 20%

```{r fig.width = 12}
dns_data_fetched.sum_attacks_quarterly.sum_period %>% 
  mutate(year_period=as.factor(year_period)) %>%
  filter(quantity_percentage > 0.1) %>%
  ggplot( aes(x=year_period, y=quantity_percentage, fill=qtype)) +
    geom_bar(stat="identity", width = 0.5) +
    geom_text(aes(label = paste(round(quantity_percentage, 2), "%")), position = position_stack(vjust = 0.1)) +
    scale_fill_viridis(discrete=TRUE, name="") +
    ylab("Percentage of attacks") +
    ggtitle("All QTYPES - stacked bars")
```

- Esse gráfico apresenta que ANY é a maioria em todos os trimestre em que os dados foram coletados com uma predominância grande (98%+) nos três primeiros trimestres (2020/Q4, 2021/Q1, 2021/Q2) e teve uma pequema queda nos dois últimos trimestres (2021/Q4 - 83.49%, 2022/Q1 - 80.52%) liberando a entrada dos QTYPES A (9.3% e 15.%) e MX (7.02% e 4.24%). 
- Outros valores aparecem no gráfico também, contudo são valores menores que 1% então foram desconsiderados

### Quantidade de ataques por query_id e sobreposição
- Para iniciar essa análise de dados foi verificado que inúmeros ataques utilizavam o mesmo query_id, como apresentado no top 5 abaixo que o query_id "17767" foi utilizado em 87.924 ataques diferentes somando 9.063.853 requisições utilizando o mesmo query_id entre cerca de 30 domínios diferentes e isso levantou algumas dúvidas, pois porque tantos ataques utilizavam o mesmo query_id ?

```{r}
data %>%
  group_by(query_id) %>%
  summarise(requests_per_attack = sum(requests_per_attack), n = n(), qnames_diff = n_distinct(qname)) %>%
  arrange(desc(n)) %>%
  head(5)
```
- Uma teoria que vem a mente é que como muitos desses ataques utilizaram o mesmo query_id, talvez eles utilizem a mesma ferramenta para realizar esses ataques e nem se deram ao trabalho de alterar o query_id ou utilizar um número randômico para realizar os ataques...
- Algo interessante é verificar se eles ocorrem no mesmo período ou seja, observar se um ataque acontece enquanto outro ataque com o mesmo query_id acontece o que pode indicar inúmeros ataques de diferentes ip para um mesmo alvo (domínio - qname).
  - Então se o tempo inicio de um ataque esta entre o inicio e fim de outro ataque ou o tempo final esta entre o inicio e fim de outro ataque, é somado 1 ao contador (amount_overlap).

```{r}
dns_data_overlap_fetched %>% 
  arrange(desc(amount_overlap)) %>%
  select('query_id', 'qtype', 'qname', 'requests_per_attack', 'ip', 'amount_overlap') %>%
  head(5)
```
- Com a tabela acima é possível observar que existe muita sobreposição entre os ataques que utilizam o mesmo QTYPE e o mesmo query_id com o ataque para o domínio "wzb.eu." que teve 658 ataques com o mesmo query_id "17767" e qtype "ANY" ocorrendo durante o período em que aquele ataque ocorria 

<!-- - Dessa diferentes ataques utilizavam o mesmo query_id, como ataques para o domínio "sl." e "wzb.eu." e "isc.org." todos utilizavam o mesmo query_id "17767"  -->

## Conclusões
- Enfim, os ataques com o qtype "ANY" ainda é o mais utilizado em todos os períodos, indicando que a depreciação desse tipo de query ANY com "*" não modificou a forma com que os atacantes realizam os seus ataques, muito provavelmente devido aos servidores DNS não realizaram uma atualização e assim essa query ainda esteja disponível ao invés de depreciada, conforme [sugerido](https://blog.cloudflare.com/what-happened-next-the-deprecation-of-any/) em 2016, assim os atacantes podem continuar abusando dessa forma de amplificação. 

- Além disso, o grande número de ataques utilizando o mesmo query_id e também a quantidade de sobreposição entre os ataques indicam que muitos deles utilizaram a mesma ferramenta para realizar os ataques. Ainda mais pois os atacantes nem sequer se deram ao trabalho de alterar o query_id ou utilizar um número randômico/incremental para o query_id ser diferente.

<!-- - Outro fato interessante que pode ser observado é que muitos ataques se sobrepõem (seu tempo de inicio e fim contém o início e fim de outro ataque para um mesmo qtype e query_id), realizamos a pesquisa de sobreposição apenas sobre ataques com um mesmo qtype, mesmo query_id e mesmo qname, porém acredito que vale realizar uma busca para verificar a quantidade de ataques sobrepostos a um mesmo qname com query_id diferentes em que ocorram sobreposições para observar os ataques em que são realizados em massa para um mesmo qname em um mesmo período de tempo -->

